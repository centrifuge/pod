# Centrifuge POD (Private Off-chain Data)

The purpose of this document is to provide more information regarding the basic functionality of the Centrifuge POD.

# Table of Contents
1. [POD Bootstrap](#pod-bootstrap)
   - [Installation](#installation)
   - [Configuration](#configuration)
2. [Accounts](#accounts)
   - [Account Data](#account-data)
   - [Account Creation](#account-creation)
   - [Account Bootstrap](#account-boostrap)
   - [Identities](#identities)
3. [Authentication](#authentication)
   - [Token](#token)
   - [Usage](#usage)
5. [NFTs](#nfts)
   - [IPFS](#ipfs)
6. [Jobs](#jobs)
7. [Webhooks](#webhooks)

## POD Bootstrap

### Installation

Before being able to transfer and anchor financial documents and mint NFTs, you need to spin up a Centrifuge POD on your machine. This is a one time setup.

Follow these steps to install the Centrifuge POD:

1. Download and install the latest [Centrifuge binary](https://github.com/centrifuge/go-centrifuge/releases). <!-- update link-->

If you want to build the node from source, follow the description in the [source code](https://github.com/centrifuge/go-centrifuge/blob/develop/README.md).

2. Add the Centrifuge binary to the `$PATH` or modify the command invocation to point to the correct library.

### Configuration

Run `centrifuge createconfig` as seen in the example below. This command automatically creates an identity and the required key pairs. It then generates the `config.yaml` file required to run the node.

```bash
$ centrifuge createconfig \\
-n mainnet \\
-t <DEFINE_CONFIG_DIR_NAME> \\
-a 8082 -p 38204 \\
--centchainurl <your centchain endpoint> \\
--ipfsPinningServiceName pinata \\
--ipfsPinningServiceURL <pinata endpoint> \\
--ipfsPinningServiceAuth <your pinata auth token> \\
--podOperatorSecretSeed <secret seed for POD operator> \\
--podAdminSecretSeed <secret seed for POD admin> \\
```

**NOTE**:

- **The generated `config.yaml` includes sensitive information regarding the accounts used to authenticate and sign transactions. Make sure to store it in a secure environment.**


- `podOperatorSecretSeed` - if this is omitted a new secret seed will be generated by the node, please see [POD operator](#pod-operator) for more information regarding this account.


- `podAdminSecretSeed` - if this is omitted a new secret seed will be generated by the node, please see [POD admin](#pod-admin) and [usage](#usage) for more information regarding this account.


- For more information regarding IPFS pinning, please see [IPFS](#ipfs).

---

## Accounts

[//]: # (TODO: Update the swagger link to the latest version.)
The `Accounts` section of our [swagger API docs](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/Accounts) provides
an overview of all the endpoints available for handling accounts.

---

An account is the POD representation of the user that is performing various operations. This identity of this account
is used when storing documents and performing any action related to the document handling process such as - starting long-running
tasks for committing or minting documents, or sending the document via the p2p layer.

### Account Data

The data stored for each account has the following JSON format:

```json
{
  "data": [
    {
      "identity": "string",
      "document_signing_public_key": [
        0
      ],
      "p2p_public_signing_key": [
        0
      ],
      "pod_operator_account_id": [
        0
      ],
      "precommit_enabled": true,
      "webhook_url": "string"
    }
  ]
}
```

`identity` - hex encoded Centrifuge Chain account ID. This is the identity used for performing the operations described above.

`document_signing_public_key` - read-only - public key that is used for signing documents, this is generated for each account that is created on the POD.

`p2p_public_signing_key` - read-only - public key that is used for interactions on the p2p layer, this is generated during POD [configuration](#configuration).

`pod_operator_account_id` - read-only - the POD operator account ID. See [POD operator](#pod-operator).

`precommit_enabled` - flag that enables anchoring the document prior to requesting the signatures from all collaborators.

`webhook_url` - URL of the webhook that is used for sending updates regarding documents or jobs.

### Account Creation

[//]: # (TODO: Update the swagger link to the latest version.)

An account can be created by calling the [account creation endpoint](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/Accounts/generate_account_v2) with a valid admin token (see [token usage](#usage)),
and providing the required information - `identity`, `precommit_enabled`, `webhook_url`.

The successful response for the account creation operation will contain the fields mentioned above in [Data](#account-data).

### Account Boostrap

**NOTE** - The following steps are required to ensure that the POD can use a newly created identity.

1. Store the `document_signing_public_key` and `p2p_public_signing_key` in the `Keystore` of Centrifuge Chain.

   This can be done by submitting the `addKeys` extrinsic of the `Keystore` pallet.
2. Add the POD operator account ID as a `PodOperation` proxy to the `identity`.

   This can be done by submitting the `addProxy` extrinsic of the `Proxy` pallet.

### Identities

Most of the operations performed by the POD rely on the presence of proxies that are used to:
- sign JSON Web3 Tokens used for [authentication](#authentication).
- sign extrinsics that are performed on behalf of the identity (see [POD operator](#pod-operator)).

#### POD-specific Accounts

##### POD Admin

The POD admin is an account that is stored on the POD, and its sole purpose is to authorize access for some account related endpoints such as
account generation, accounts listing, and account details retrieval.
This is required since not every user should have the rights to perform the mentioned actions.

##### POD Operator

The POD operator is an account that is stored on the POD, and it is used for submitting extrinsics on behalf of the provided identity.
This is required since an identity can be an anonymous proxy, which is unable to sign any extrinsics.

Given the purpose of this account, it is expected that it's properly funded in order to cover for the transaction fees.

---

## Authentication

Authentication is performed using the JSON Web3 Tokens described [here](https://github.com/hamidra/jw3t).

### Token

The format of the JW3 token that we use is:

`base_64_encoded_json_header.base_64_encoded_json_payload.base_64_encoded_signature`

Where the un-encoded parts are as follows:

Header:

```json
{
  "algorithm": "sr25519", 
  "token_type": "JW3T", 
  "address_type": "ss58"
}
```

---

Payload:

```json
{
  "address": "delegate_address",
  "on_behalf_of": "delegator_address",
  "proxy_type": "proxy_type",
  "expires_at": "1663070957",
  "issued_at": "1662984557",
  "not_before": "1662984557"
}
```

`address` - SS58 address of the proxy delegate (see [usage](#usage) for more info).

`on_behalf_of` - SS58 address of the proxy delegator (see [usage](#usage) for more info).

`proxy_type` - one of the allowed proxy types (see [usage](#usage) for more info):

- `PodAdmin` - defined in the POD.
- `Any` - defined in the Centrifuge Chain.
- `PodOperation` - defined in the Centrifuge Chain.
- `PodAuth` - defined in the Centrifuge Chain.

`expires_at` - token expiration time.

`issued_at` - token creation time.

`not_before` - token activation time.

---

Signature - the `Schnorrkel/Ristretto x25519` signature generated for `json_header.json_payload`.

---

### Usage

The POD has 2 types of authentication mechanisms:

1. On-chain proxies - this is the most commonly used mechanism, and it is used to authenticate any on-chain proxies of the identity.

   In this case, the `address`, `on_behalf_of` and `proxy_type` should contain the information as found on-chain.

   Example:

   `Alice` - identity.

   `Bob` - proxy of `Alice` with type `PodAuth`.

   Token payload:

   ```json
   {
     "address": "ss58_address_of_bob",
     "on_behalf_of": "ss58_address_of_alice",
     "proxy_type": "PodAuth",
     "expires_at": "1663070957",
     "issued_at": "1662984557",
     "not_before": "1662984557"
   }
   ```

2. POD admin - this is used when performing authentication for restricted endpoints.

   In this case, the `address` and `on_behalf_of` fields should be equal and contain the SS58 address of the POD admin, and
   the `proxy_type` should be `PodAdmin`.

   Example:

   ```json
   {
     "address": "pod_admin_ss58_address",
     "on_behalf_of": "pod_admin_ss58_address",
     "proxy_type": "PodAdmin",
     "expires_at": "1663070957",
     "issued_at": "1662984557",
     "not_before": "1662984557"
   }
   ```

---

## NFTs

[//]: # (TODO: Update the swagger link to the latest version.)

The `NFTs` section of our [swagger API docs](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/NFTs) provides
an overview of all the endpoints available for handling document NFTs.

The NFT endpoint provides basic functionality for minting NFTs for a document and retrieving NFT specific information
such as attributes, metadata, and owner.

### IPFS

When minting NFTs, additional information is stored on-chain and on IPFS, as follows:

- document fields that are specified in the minting request are saved on IPFS under the following format:

  ```json
  {
    "name": "ipfs_name",
    "description": "ipfs_description",
    "image": "ipfs_image",
    "properties": {
      "AssetIdentifier": "0x25680a49ff1b6368f7e243130ff957f9523b917c8c83d79aab97c0ef99fd3b15",
      "AssetValue": "100",
      "MaturityDate": "2022-10-13T11:07:28.128752151Z",
      "Originator": "0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d",
      "result": "0x0000000000000000000000000000000100000000000000000000000000000064"
    }
  }
  ```

  **NOTE** - at the moment, the only IPFS pinning service that is supported is [pinata](https://www.pinata.cloud/).


- the IPFS hash of the above mentioned fields is set as metadata to the NFT on chain, in the following format - `/ipfs/QmfN7u6hMRHxL83Jboa4bHgme4PJmcS4eQFnkrXye5ctAM`


- the document ID and document version are set as attributes to the NFT on chain.


**NOTE** - All the above information can be found on chain by querying the related storages of the `Uniques` pallet.

---

## Documents

[//]: # (TODO: Update the swagger link to the latest version.)

The `Documents` section of our [swagger API docs](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/Documents) provides
an overview of all the endpoints available for handling documents.

The main purpose of the POD is to serve as a handler for documents that contain private off-chain data, as described above.

---

## Jobs

[//]: # (TODO: Update the swagger link to the latest version.)

The `Jobs` section of our [swagger API docs](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/Jobs) provides
an overview of all the endpoints available for retrieving job details.

---

The jobs endpoint returns detailed information for a job. 

A job is a long-running operation that is triggered by the POD when performing actions related to documents and/or NFTs.

## Webhooks

[//]: # (TODO: Update the swagger link to the latest version.)

The `Webhook` section of our [swagger API docs](https://app.swaggerhub.com/apis/centrifuge.io/cent-node/2.1.0#/Webhook) provides
an overview the notification message that is sent by the POD for document or job events.